<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>
    </title>
    <link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />

    <script type="text/javascript" src="js/jquery-1.8.2.js"></script>
    <!-- <script type="text/javascript" src="js/jquery.maskedinput.min.js" ></script> -->
    <script type="text/javascript" src="js/jquery.mobile-1.3.0.min.js"></script>       

</head>
<body>
    <!-- Home -->
    <div data-role="page" id="busca">
        <div data-theme="d" data-role="header">
          <h3>
            Busca papéis
        </h3>
    </div>
    <div data-role="content">
        <form action="">
          <!-- data-role="fieldcontain" -->
          <fieldset data-role="controlgroup"> <!--data-role="controlgroup" -->
            <label for="tbPlMin">
                P/L mínimo
            </label>
            <input name="" id="tbPlMin" placeholder="" value="0,0" type="text" />                            
        </fieldset>

        <fieldset data-role="controlgroup">
            <label for="tbPlMax">
                P/L máximo
            </label>
            <input name="" id="tbPlMax" placeholder="" value="25,0" type="text" />
        </fieldset>

        <fieldset data-role="controlgroup">
            <label for="tbRoeMin">
                ROE mín:
            </label>
            <input name="" id="tbRoeMin" placeholder="" value="0,0" type="text" />
        </fieldset>

        <fieldset data-role="controlgroup">
            <label for="tbRoeMax">
                ROE máx:
            </label>
            <input name="" id="tbRoeMax" placeholder="" value="" type="text" />
        </fieldset>

        <fieldset data-role="controlgroup">
            <label for="tbDivPatrMin">
                Dívida / patr. mín:
            </label>
            <input name="" id="tbDivPatrMin" placeholder="" value="" type="text" />
        </fieldset>

        <fieldset data-role="controlgroup">
            <label for="tbDivPatrMax">
                Dívida / patr. máx:
            </label>
            <input name="" id="tbDivPatrMax" placeholder="" value="3" type="text" />
        </fieldset>                    
        <input type="button" id="btnBuscaEmpresa" value="Buscar" />
                    <!--  data-icon="search"
                    data-iconpos="right" -->
        <!-- ALTERACOES DIEGO -->
        <input type="button" id="btnDemos" value="Demos" />
        <!-- /ALTERACOES DIEGO -->
                </form>
            </div>
            <div data-theme="d" data-role="footer">
                <h3>
                    Feito com jQuery Mobile
                </h3>
            </div>
        </div>
        <div data-role="page" id="resultadoBusca">
            <div data-theme="d" data-role="header">
                <h3>
                    Resultado da busca
                </h3>
            </div>

            <div data-role="content">
                <table id="tblResultadoBusca" data-role="table" data-column-btn-text="Colunas" class="ui-responsive" data-mode="columntoggle">
                    <!--data-mode="columntoggle" -->
                    <!-- TODO: ver se vou usar reflow ou column toggle -->
                    <thead>
                        <tr class="ui-bar-d">
                            <th><b>Nome</b></th>                        
                            <th data-priority="1">Cotacao</th> <!--data-priority="5" -->                       
                            <th data-priority="1">Dív/patr</th>                        
                            <th data-priority="3">Patr. líq.</th>                        
                            <th data-priority="1">P/L</th>                        
                            <th data-priority="1">ROE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>a</td>
                            <td>b</td>
                            <td>c</td>
                            <td>d</td>
                            <td>e</td>
                            <td>f</td>
                        </tr>                        
                    </tbody>
                </table>
            </div>

            <div data-theme="d" data-role="footer">
                <h3>
                    Feito com jQuery Mobile
                </h3>
            </div>
        </div>

        
        <!-- ALTERACOES DIEGO -->
        <div data-role="page" id="demos">
            <div data-theme="d" data-role="header">
                <h3>
                    Demos
                </h3>
            </div>
            
            <div data-role="content">
                <p>TESTEEEEEEEEEEE</p>
            </div>
            
            <div data-theme="d" data-role="footer">
                <h3>
                    Feito com jQuery Mobile
                </h3>
            </div>
        </div>
        <!-- /ALTERACOES DIEGO -->
        <script type="text/javascript">

        jQuery.support.cors = true;
        //jQuery(function($) {
        //    $('#tbPlMin').mask("99,9", {placeholder: " "} );
        //});
        
        <!-- ALTERACOES DIEGO -->
        $("#btnDemos").on("click" , function(event) {
          $.mobile.navigate("#demos");  
        });
        <!-- /ALTERACOES DIEGO -->

        //evento de busca de papéis
        $("#btnBuscaEmpresa").on("click" , function(event) {
            event.preventDefault();
            var campos = ['#tbPlMin', '#tbPlMax', '#tbRoeMin', '#tbRoeMax', '#tbDivPatrMin', '#tbDivPatrMax'];
            for (var i = 0; i < campos.length; i++) {                    
                if( $.trim($(campos[i]).val()).length > 0 && 
                    ( $(campos[i]).val().indexOf(".") !== -1  ||
                        isNaN(parseFloatStringInBrLocale( $(campos[i]).val() )) )  ) {
                    alert("Um dos parâmertos está em formato incorreto.");
                return;
            }
        }

        var plMin = getFloatStringParameter($('#tbPlMin').val());
        var plMax = getFloatStringParameter($('#tbPlMax').val());
        var roeMin = getFloatStringParameter($('#tbRoeMin').val());
        var roeMax = getFloatStringParameter($('#tbRoeMax').val());
        var divBrutaMin = getFloatStringParameter($('#tbDivPatrMin').val());
        var divBrutaMax = getFloatStringParameter($('#tbDivPatrMax').val());
        
        // validar inputs        
        // pegar entradas            
        var serviceUrl = 'http://buscadorpapeis-prospeccaohtml5.rhcloud.com/buscadorpapeis/rest/papeis/buscar?plMin'+
        plMin+"&"+
        "plMax="+plMax+"&"+
        "roeMin="+roeMin+"&"+
        "roeMax="+roeMax+"&"+
        "divBrutaMin="+divBrutaMin+"&"+
        "divBrutaMax="+divBrutaMax;
            // construir urls
            $.ajax( {
                type: 'Get',                                       
                url: serviceUrl,
                dataType: 'jsonp',                    
                success: function(data) {
                            //alert("resultado da busca: "+data);
                            carregarResultadoBusca(data);
                            //$.mobile.navigate("#resultadoBusca");
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            alert("cors: "+jQuery.support.cors+"Erro na requisicao: "+textStatus+" - "+errorThrown);
                        }                 
                    })  
            ;
            $.mobile.navigate("#resultadoBusca");
                //$("#tblResultadoBusca tbody").html( '<div style="Margin-left:auto; Margin-right:auto;"> <img src="css\\images\\ajax-loader.gif"> </img> </div>'  );

        });

            //tratamento da resposta da busca na página de resultados
            function carregarResultadoBusca(data) {
            // como foi utilizado jsonp, o resultado retornado já é um objeto javascript, e não uma string
            var result = data;
            var r = new Array(), j = -1;
            for (var i = 0; i < result.length; i++) {
                var nome = result[i].nome;
                var cotacaoAtual = parseFloatStringInBrLocale(result[i].cotacaoAtual);
                var dividaBrutaSobrePatrimonio = parseFloatStringInBrLocale(result[i].dividaBrutaSobrePatrimonio);
                var patrimonioLiquido = parseFloatStringInBrLocale(result[i].patrimonioLiquido);
                var pL = parseFloatStringInBrLocale(result[i].precoSobreLucro);
                var roe = parseFloatStringInBrLocale(result[i].retornoSobrePatrimonio);
                //console.log(nome+" - "+cotacaoAtual+" - "+dividaBrutaSobrePatrimonio+" - "+patrimonioLiquido+" - "
                //    +pL+" - "+roe);
                // montagem da linha da tabela
                r[++j]='<tr><td> <b>';
                r[++j] = nome;
                r[++j] = '</b></td><td class="ui-table-priority-1">';
                r[++j] = cotacaoAtual;
                r[++j] = '</td><td class="ui-table-priority-1">';
                r[++j] = dividaBrutaSobrePatrimonio;
                r[++j] = '</td><td class="ui-table-priority-3">';
                r[++j] = patrimonioLiquido;
                r[++j] = '</td><td class="ui-table-priority-1">';
                r[++j] = pL;
                r[++j] = '</td><td class="ui-table-priority-1">';
                r[++j] = roe;
                r[++j] = '</td></tr>';
            }                
            $("#tblResultadoBusca tbody").append(r.join(''));
        }

        function parseFloatStringInBrLocale(arg) {
            return parseFloat(arg.replace(".","").replace(",","."));
        }

        function getFloatStringParameter(arg) {
            var res = parseFloat(arg.replace(".","").replace(",","."));
            if(isNaN(res)) {
                return "";
            }
            return String(res);
        }

        </script>

    </body>
    </html>
