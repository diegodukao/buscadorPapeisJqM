<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <title>
    </title>
    <link rel="stylesheet" href="css/jquery.mobile-1.3.0.min.css" />

    <script type="text/javascript" src="js/jquery-1.8.2.min.js"></script>
    <!-- <script type="text/javascript" src="js/jquery.maskedinput.min.js" ></script> -->
    <script type="text/javascript" src="js/jquery.mobile-1.3.0.min.js"></script>  
   <!-- <script type="text/javascript" src="js/highcharts/highcharts.js"></script>-->
    <script type="text/javascript" src="js/highcharts/highstock.js" ></script>     

</head>
<body>
    <!-- Home -->
    <div data-role="page" id="busca">
        <div data-theme="d" data-role="header">
          <h3>
            Busca pap��is
        </h3>
    </div>
   <!-- DIV ALTERADA -->
    <div data-role="content">
        <form action="">
            <table width="100%">
                <tr>
                    <th></th>
                    <th>Min</th>
                    <th>Max</th>
                </tr>
                <tr>
                    <td>P/L</td>
                    <td><input type="text" id="tbPlMin" placeholder="" value="0,0" type="text"></td>
                    <td><input type="text" id="tbPlMax" placeholder="" value="25,0" type="text"></td>
                </tr>
                <tr>
                    <td>ROE</td>
                    <td><input type="text" id="tbRoeMin" placeholder="" value="0,0" type="text"></td>
                    <td><input type="text" id="tbRoeMax" placeholder="" value="" type="text"></td>
                </tr>
                <tr>
                    <td>Div/Ptr</td>
                    <td><input type="text" id="tbDivPatrMin" placeholder="" value="" type="text"></td>
                    <td><input type="text" id="tbDivPatrMax" placeholder="" value="3" type="text"></td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <input type="button" id="btnBuscaEmpresa" value="Buscar" class="btnPrincipal" data-theme="b"   />
                    </td>
                    <td>
                        <a href="#demos" data-role="button" data-transition="slide">Demos</a>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td colspan="2">
                        <a href="#demosPhonegap" data-role="button" data-transition="slide">Demos PhoneGap</a>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <!-- /DIV ALTERADA -->
<div data-theme="d" data-role="footer">
    <h3>
        Feito com jQuery Mobile
    </h3>
</div>
<div data-theme="g" data-role="footer">
    <center>
        <img src="css/images/Principal_h-RGB_baixa.jpg" width="160px" />
    </center>
</div>
</div>

<div data-role="page" id="resultadoBusca">
    <div data-theme="d" data-role="header">
        <a href="index.html" data-icon="home" data-transition="slide">Home</a>
        <h3>
            Resultado da busca            
        </h3>
    </div>    

    <div data-role="content">
        <table id="tblResultadoBusca" data-role="table" data-column-btn-text="Colunas" class="ui-responsive" data-mode="columntoggle">
            <!--data-mode="columntoggle" -->
            <!-- TODO: ver se vou usar reflow ou column toggle -->
            <thead>
                <tr class="ui-bar-d">
                    <th><b>Nome</b></th>                        
                    <th data-priority="1">Cotacao</th> <!--data-priority="5" -->                       
                    <th data-priority="1">D��v/patr</th>                        
                    <th data-priority="3">Patr. l��q.</th>                        
                    <th data-priority="1">P/L</th>                        
                    <th data-priority="1">ROE</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>a</td>
                    <td>b</td>
                    <td>c</td>
                    <td>d</td>
                    <td>e</td>
                    <td>f</td>
                </tr>                        
            </tbody>
        </table>
    </div>

    <div data-theme="d" data-role="footer">
        <h3>
            Feito com jQuery Mobile
        </h3>
    </div>
    <div data-theme="g" data-role="footer">
        <center>
            <img src="css/images/Principal_h-RGB_baixa.jpg" width="160px" />
        </center>
    </div>


</div>

<div data-role="page" id="demos">
    <div data-role="panel" id="mypanel" data-position="right">
        <p>Teste de painel lateral</p>
    </div>

    <div data-theme="d" data-role="header">
        <a href="#" data-icon="home" data-transition="slide" data-rel="back">Home</a>
        <h1>Demos</h1>
        <a href="#mypanel" data-icon="bars">Menu</a>
    </div>

    <div data-role="content">
        <div>
            <form data-inline="true">
                <label for="flip-1">Toggle</label>
                <select name="flip-1" id="flip-1" data-role="slider" data-inline="true">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
                <br>

                <fieldset data-role="controlgroup" data-type="horizontal">
                    <legend>Radio:</legend>
                    <input name="radio-choice-h-2" id="radio-choice-h-2a" value="on" checked="checked" type="radio">
                    <label for="radio-choice-h-2a">One</label>
                    <input name="radio-choice-h-2" id="radio-choice-h-2b" value="off" type="radio">
                    <label for="radio-choice-h-2b">Two</label>
                    <input name="radio-choice-h-2" id="radio-choice-h-2c" value="other" type="radio">
                    <label for="radio-choice-h-2c">Three</label>
                </fieldset>
                <br>

                <div data-role="rangeslider">
                    <label for="range-1a">Rangeslider:</label>
                    <input name="range-1a" id="range-1a" min="0" max="100" value="40" type="range">
                    <label for="range-1b">Rangeslider:</label>
                    <input name="range-1b" id="range-1b" min="0" max="100" value="80" type="range">
                </div>
            </form>
            <br>

            <p>Lista com accordion</p>
            <a href="#popupNested" data-rel="popup" data-role="button" data-inline="true" data-icon="bars" data-theme="b" data-transition="pop">Choose a creature...</a>
            <div data-role="popup" id="popupNested" data-theme="none">
                <div data-role="collapsible-set" data-theme="b" data-content-theme="c" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-d" style="margin:0; width:250px;">
                    <div data-role="collapsible" data-inset="false">
                        <h2>Farm animals</h2>
                        <ul data-role="listview">
                            <li><a href="#" data-rel="dialog">Chicken</a></li>
                            <li><a href="#" data-rel="dialog">Cow</a></li>
                            <li><a href="#" data-rel="dialog">Duck</a></li>
                            <li><a href="#" data-rel="dialog">Sheep</a></li>
                        </ul>
                    </div><!-- /collapsible -->
                    <div data-role="collapsible" data-inset="false">
                        <h2>Pets</h2>
                        <ul data-role="listview">
                            <li><a href="#" data-rel="dialog">Cat</a></li>
                            <li><a href="#" data-rel="dialog">Dog</a></li>
                            <li><a href="#" data-rel="dialog">Iguana</a></li>
                            <li><a href="#" data-rel="dialog">Mouse</a></li>
                        </ul>
                    </div><!-- /collapsible -->
                    <div data-role="collapsible" data-inset="false">
                        <h2>Ocean Creatures</h2>
                        <ul data-role="listview">
                            <li><a href="#" data-rel="dialog">Fish</a></li>
                            <li><a href="#" data-rel="dialog">Octopus</a></li>
                            <li><a href="#" data-rel="dialog">Shark</a></li>
                            <li><a href="#" data-rel="dialog">Starfish</a></li>
                        </ul>
                    </div><!-- /collapsible -->
                    <div data-role="collapsible" data-inset="false">
                        <h2>Wild Animals</h2>
                        <ul data-role="listview">
                            <li><a href="#" data-rel="dialog">Lion</a></li>
                            <li><a href="#" data-rel="dialog">Monkey</a></li>
                            <li><a href="#" data-rel="dialog">Tiger</a></li>
                            <li><a href="#" data-rel="dialog">Zebra</a></li>
                        </ul>
                    </div><!-- /collapsible -->
                </div><!-- /collapsible set -->
            </div><!-- /popup -->
            <br><br>

            <p>Par��grafo com ��cone "saiba mais" <a href="#popupInfo" data-rel="popup" data-role="button" class="ui-icon-alt" data-inline="true" data-transition="pop" data-icon="info" data-theme="e" data-iconpos="notext">Saiba mais</a></p>
            <div data-role="popup" id="popupInfo" class="ui-content" data-theme="e" style="max-width:350px;">
               <a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>
               <p>Explica����o sobre o texto do par��grafo</p>
           </div>
           <br>

           <p>Exemplo de log in</p>
           <a href="#popupLogin" data-rel="popup" data-position-to="window" data-role="button" data-inline="true" data-icon="check" data-theme="a" data-transition="pop">Entrar</a>
           <div data-role="popup" id="popupMenu" data-theme="a">
            <div data-role="popup" id="popupLogin" data-theme="a" class="ui-corner-all">
                <form>
                    <div style="padding:10px 20px;">
                      <h3>Please sign in</h3>
                      <label for="un" class="ui-hidden-accessible">Username:</label>
                      <input name="user" id="un" value="" placeholder="username" data-theme="a" type="text">
                      <label for="pw" class="ui-hidden-accessible">Password:</label>
                      <input name="pass" id="pw" value="" placeholder="password" data-theme="a" type="password">
                      <button type="submit" data-theme="b" data-icon="check">Sign in</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

</div>

<div data-role="footer" data-theme="d">
    <div data-role="navbar" data-iconpos="left">
        <ul>
            <li><a href="#" data-icon="grid">Summary</a></li>
            <li><a href="#" data-icon="star" class="ui-btn-active">Favs</a></li>
            <li><a href="#" data-icon="gear">Setup</a></li>
        </ul>
    </div><!-- /navbar -->
    <p style="text-align:center;">Footer com bot��es</p>
</div><!-- /footer -->
<div data-theme="g" data-role="footer">
    <center>
        <img src="css/images/Principal_h-RGB_baixa.jpg" width="160px" />
    </center>
</div>
</div>

<div data-role="page" id="graficoCotacoes">

    <div data-theme="d" data-role="header">
        <a href="index.html" data-icon="home" data-transition="slide">Home</a>
        <h3>
            Gr��fico de cota����es
        </h3>
    </div>

    <div data-role="content">
        <div id="divGraficoCotacoes">            
                Carregando ...
                <img src="css\\images\\ajax-loader-bar.gif"> </img>            
        </div>

    </div>  

    <div data-theme="d" data-role="footer">
        <h3>
            Feito com jQuery Mobile
        </h3>
    </div>
    <div data-theme="g" data-role="footer">
    <center>
        <img src="css/images/Principal_h-RGB_baixa.jpg" width="160px" />
    </center>
</div>

</div>

<div data-role="page" id="demosPhonegap">
    <div data-theme="d" data-role="header">
        <a href="#" data-icon="home" data-transition="slide" data-rel="back">Home</a>
        <h1>Demos PhoneGap</h1>
    </div>
    
    <div data-role="content">
        <table>
            <tr>
                <td>
                    <input type="button" id="btnFoto" value="Testar camera"  onClick="capturePhoto();"   />
                </td>
                <td>
                    <input type="button" id="btnFoto" value="Tocar Mp3"  onClick="playAudio('media/audio.mp3');"   />
                </td>
            </tr>
        </table>
    </div>

    
    <div data-theme="d" data-role="footer">
        <h3>
            Feito com jQuery Mobile
        </h3>
    </div>
    <div data-theme="g" data-role="footer">
        <center>
            <img src="css/images/Principal_h-RGB_baixa.jpg" width="160px" />
        </center>
    </div>
</div>

<script type="text/javascript">
   

    function geraGrafico(data, nome) {
        var chart1 = new Highcharts.StockChart({
            chart: {
                renderTo: 'divGraficoCotacoes'                
            },
            rangeSelector: {
                selected : 2
            },
            title: {
                text: 'Hist��rico de ' + nome
            },            
            series: [{
                type: 'candlestick',
                name: 'PETR4',
                data: data
            }]
        });
    }


    jQuery.support.cors = true;



    //evento de busca de pap��is
    $("#btnBuscaEmpresa").on("click" , function(event) {
        event.preventDefault();
        var campos = ['#tbPlMin', '#tbPlMax', '#tbRoeMin', '#tbRoeMax', '#tbDivPatrMin', '#tbDivPatrMax'];
        for (var i = 0; i < campos.length; i++) {                    
            if( $.trim($(campos[i]).val()).length > 0 && 
                ( $(campos[i]).val().indexOf(".") !== -1  ||
                    isNaN(parseFloatStringInBrLocale( $(campos[i]).val() )) )  ) {
                alert("Um dos par��mertos est�� em formato incorreto.");                        
            return false;
        }
    }

    var plMin = getFloatStringParameter($('#tbPlMin').val());
    var plMax = getFloatStringParameter($('#tbPlMax').val());
    var roeMin = getFloatStringParameter($('#tbRoeMin').val());
    var roeMax = getFloatStringParameter($('#tbRoeMax').val());
    var divBrutaMin = getFloatStringParameter($('#tbDivPatrMin').val());
    var divBrutaMax = getFloatStringParameter($('#tbDivPatrMax').val());

    if( $.trim(plMin).length>0 &&  $.trim(plMax).length>0 && parseFloat(plMin) > parseFloat(plMax) ) {
        alert("O P/L m��nimo deve ser menor ou igual ao P/L m��ximo");
            // importante retornar false para o bot��o n��o permanecer com o estilo "clicado"                
            return false;
        }
        if( $.trim(roeMin).length>0 &&  $.trim(roeMax).length>0 && parseFloat(roeMin) > parseFloat(roeMax) ) {
            alert("O ROE m��nimo deve ser menor ou igual ao ROE m��ximo");                
            $('.ui-btn-active').removeClass('ui-btn-active');
            return false;
        }
        if( $.trim(divBrutaMin).length>0 &&  $.trim(divBrutaMax).length>0 && parseFloat(divBrutaMin) > parseFloat(divBrutaMax) ) {
            alert("A d��vida bruta sobre patrim��nio m��nima deve ser menor ou igual ao m��ximo");                
            $('.ui-btn-active').removeClass('ui-btn-active');
            return false;
        }


    // pegar entradas            
    var serviceUrl = 'http://buscadorpapeis-prospeccaohtml5.rhcloud.com/buscadorpapeis/rest/papeis/buscar?plMin='+
    plMin+"&"+
    "plMax="+plMax+"&"+
    "roeMin="+roeMin+"&"+
    "roeMax="+roeMax+"&"+
    "divBrutaMin="+divBrutaMin+"&"+
    "divBrutaMax="+divBrutaMax;
        // construir urls
        $.ajax( {
            type: 'Get',                                       
            url: serviceUrl,
            dataType: 'jsonp',                    
            success: function(data) {
                        //alert("resultado da busca: "+data);
                        carregarResultadoBusca(data);
                        //$.mobile.navigate("#resultadoBusca");
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        alert("cors: "+jQuery.support.cors+"Erro na requisicao: "+textStatus+" - "+errorThrown);
                    }                 
                })  
        ;
        $("#tblResultadoBusca tbody").html('');
        $.mobile.navigate("#resultadoBusca");
        $("#tblResultadoBusca tbody").html( '<tr><td colspan=6> Carregando ...<img src="css\\images\\ajax-loader-bar.gif"> </img> </td></tr>'  );

        });

        //tratamento da resposta da busca na p��gina de resultados
        function carregarResultadoBusca(data) {
        // como foi utilizado jsonp, o resultado retornado j�� �� um objeto javascript, e n��o uma string
        var result = data;
        var r = new Array(), j = -1;
        for (var i = 0; i < result.length; i++) {
            var nome = result[i].nome;
            var cotacaoAtual = parseFloatStringInBrLocale(result[i].cotacaoAtual);
            var dividaBrutaSobrePatrimonio = parseFloatStringInBrLocale(result[i].dividaBrutaSobrePatrimonio);
            var patrimonioLiquido = parseFloatStringInBrLocale(result[i].patrimonioLiquido);
            var pL = parseFloatStringInBrLocale(result[i].precoSobreLucro);
            var roe = parseFloatStringInBrLocale(result[i].retornoSobrePatrimonio);
            //console.log(nome+" - "+cotacaoAtual+" - "+dividaBrutaSobrePatrimonio+" - "+patrimonioLiquido+" - "
            //    +pL+" - "+roe);
            // montagem da linha da tabela
            r[++j]='<tr><td> <b>';
                r[++j]='<a href="#" onClick="showGraficoCotacoes(\'' + result[i].nome + '\')" data-transition="slide">';
            r[++j] = nome;
            r[++j] = '</a></b></td><td class="ui-table-priority-1">';
            r[++j] = cotacaoAtual;
            r[++j] = '</td><td class="ui-table-priority-1">';
            r[++j] = dividaBrutaSobrePatrimonio;
            r[++j] = '</td><td class="ui-table-priority-3">';
            r[++j] = patrimonioLiquido;
            r[++j] = '</td><td class="ui-table-priority-1">';
            r[++j] = pL;
            r[++j] = '</td><td class="ui-table-priority-1">';
            r[++j] = roe;
            r[++j] = '</td></tr>';
        }                
        $("#tblResultadoBusca tbody").html(r.join(''));
        $("#tblResultadoBusca tr:odd").css("background-color", "#FDFDFD");
        $("#tblResultadoBusca tr:even").css("background-color", "#EFEFEF");
       
    }

  function showGraficoCotacoes(nome){
            location.href = "#graficoCotacoes";
            $.ajax( {
                type: 'Get',                                       
                url: 'http://buscadorgraficos-prospeccaohtml5.rhcloud.com/buscadorgraficos/rest/papeis/buscar?nomePapel=PETR4&dataInicial=01/01/2010&dataFinal=20/03/2013',
                dataType: 'jsonp',                    
                success: function(data) {
                            //alert("resultado da busca: "+data);
                            geraGrafico(data, nome);
                            //$.mobile.navigate("#resultadoBusca");
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            alert("cors: "+jQuery.support.cors+"Erro na requisicao: "+textStatus+" - "+errorThrown);
                        }                 
                    })  
            ;
        }

    function parseFloatStringInBrLocale(arg) {
        return parseFloat(arg.replace(".","").replace(",","."));
    }

    function getFloatStringParameter(arg) {
        var res = parseFloat(arg.replace(".","").replace(",","."));
        if(isNaN(res)) {
            return "";
        }
        return String(res);
    }

    </script>

    <style type="text/css">
        /*.ui-page .ui-content .ui-btn.my-btn .ui-btn-inner .btnPrincipal*/
        /*.ui-btn .ui-shadow .ui-btn-corner-all , .btnPrincipal {
            color: red;
             background: rgb(0,0,255); 
        }


        .ui-btn .ui-shadow .ui-btn-corner-all .ui-btn-up-c {

            background: red;
        }

        body {

            background: red;
        }*/

    </style>

	<script type="text/javascript" src="cordova-2.5.0.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
        
        	// Wait for Cordova to connect with the device
		    //
		    document.addEventListener("deviceready",onDeviceReady,false);
        
            app.initialize();
            
            var cameraOptions;
            var pictureSource;   // picture source
		    var destinationType; // sets the format of returned value 
		
		    
		
		    // Cordova is ready to be used!
		    //
		    function onDeviceReady() {
		        pictureSource=navigator.camera.PictureSourceType;
		        destinationType=navigator.camera.DestinationType;
		        cameraOptions = { quality : 75,
				  destinationType : Camera.DestinationType.FILE_URI,
				  sourceType : Camera.PictureSourceType.CAMERA,
				  allowEdit : true,
				  encodingType: Camera.EncodingType.JPEG,
				  //targetWidth: 100,
				  //targetHeight: 100,
				  //popoverOptions: CameraPopoverOptions,
				  saveToPhotoAlbum: true };
		    }
            
            // Called when a photo is successfully retrieved
		    //
		    function onPhotoDataSuccess(imageData) {
		      // Uncomment to view the base64 encoded image data
		      // console.log(imageData);
		
		      // Get image handle
		      //
		      var smallImage = document.getElementById('smallImage');
		
		      // Unhide image elements
		      //
		      smallImage.style.display = 'block';
		
		      // Show the captured photo
		      // The inline CSS rules are used to resize the image
		      //
		      smallImage.src = "data:image/jpeg;base64," + imageData;
		    }
            
            // Called if something bad happens.
		    // 
		    function onFail(message) {
		      alert('Failed because: ' + message);
		    }
            
            function capturePhoto() {
		      // Take picture using device camera and retrieve image as base64-encoded string
		      navigator.camera.getPicture(onPhotoDataSuccess, onFail, cameraOptions);
		    }
            
            
            // MP3 PLAYER
            //#######################################
            function getPhoneGapPath() {
                var path = window.location.pathname;
                path = path.substr( 0, path.length - 10 );
                return 'file://' + path;
            };

            function playAudio(song_path) {
                // Create Media object from src
                //my_media = new Media(src, onSuccess, onError);
                src = getPhoneGapPath() + song_path;
                var my_media = new Media(src, onSuccess, onError);

                // Play audio
                my_media.play();

                // Update my_media position every second
                //if (mediaTimer == null) {
                    //mediaTimer = setInterval(function() {
                    var mediaTimer = setInterval(function() {
                        // get my_media position
                        my_media.getCurrentPosition(
                            // success callback
                            function(position) {
                                if (position > -1) {
                                    setAudioPosition((position) + " sec");
                                }
                            },
                            // error callback
                            function(e) {
                                console.log("Error getting pos=" + e);
                                setAudioPosition("Error: " + e);
                            }
                        );
                    }, 1000);
                //}
            };

            function onSuccess() {
                console.log("playAudio():Audio Success");
            };

            // onError Callback 
            //
            function onError(error) {
                alert('code: '    + error.code    + '\n' + 
                      'message: ' + error.message + '\n');
            };
            //#############################################
     </script>

    </body>
    </html>
